---
title: "Formative Assessment `0"
author: "Sinocruz, A & Tagaytay, G"
date: "2025-12-05"
output: pdf_document
---
github link: 

## **Introduction**

This study examines the impact of two margarine brands (Brand A and Brand B) on cholesterol levels at three different time points: prior to consumption, four weeks later, and eight weeks later. Both the within-subjects factor (Time) and the between-subjects factor (Margarine type) are evaluated using a two-way mixed model ANOVA, which enables the analysis of main effects and interactions.

## Null Hypothesis

There is no significant difference in the cholesterol levels between the two brands of margarine over the three time points.

## Dataset

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(car)
library(reshape2)
library(afex)
library(ggplot2)
library(rstatix)
library(biotools)
library(emmeans) 

df <- read.csv("Cholesterol_R2.csv")

df_long <- df %>%
pivot_longer(cols = c(Before, After4weeks, After8weeks),
names_to = "Time",
values_to = "Chol")

df_long$Time <- factor(df_long$Time,
levels = c("Before", "After4weeks", "After8weeks"))
df_long$Margarine <- factor(df_long$Margarine)

```

```{r,warning=FALSE, message=FALSE}
library(knitr)
library(kableExtra)

# Create a sample dataframe if needed
# df <- data.frame(...) 

# Generate the table
kable(df, caption = "Cholesterol Data", booktabs = TRUE) %>%
  kable_styling(latex_options = c("hold_position")) %>%
  row_spec(seq(1, nrow(df), by = 2), background = "lightblue")
```

## Problem

The research question here is:

> Do cholesterol levels change over time for each margarine brand individually?

{add more if needed}

## Checking of Assumptions

#### Assumption 1: You have a continuous dependent variable.

**Remark.** The dependent variable in this study is the Cholesterol Level of the participants. This variable is quantitative and measured on a continuous scale (likely interval or ratio), meaning it can theoretically take on any value within a specific range (e.g., measured in mg/dL). Because the outcome variable is numeric and allows for meaningful arithmetic operations, Assumption 1 is satisfied.

#### Assumption 2: You have one between-subjects factor (i.e., independent variable) that is categorical with two or more categories.

**Remark.** The between-subjects independent variable is the Margarine Brand. This is a nominal, categorical variable that consists of two distinct levels: Brand A and Brand B. It is classified as a "between-subjects" factor because the participants are divided into mutually exclusive groups, where each participant is assigned to consume only one specific brand (either Brand A or Brand B), but not both.

#### Assumption 3: You have one within-subjects factor (i.e., independent variable) that is categorical with two or more categories (Brand A, Brand B).

**Remark.** The within-subjects independent variable is Time, which represents the specific intervals at which data was collected. This factor is categorical and consists of three related levels: Baseline (Before), After 4 Weeks, and After 8 Weeks. It is classified as a "within-subjects" (or repeated measures) factor because the exact same participants were measured across all three time points to observe changes within the same individuals over the duration of the study.

#### Assumption 4: There should be no significant outliers in any cell of the design.

```{r assumption4-rainclouds, echo=FALSE, message=FALSE, warning=FALSE}
library(tidyverse)
library(ggplot2)

df <- read.csv("Cholesterol_R2.csv")

df_long <- df %>%
  pivot_longer(
    cols = c(Before, After4weeks, After8weeks),
    names_to = "Time",
    values_to = "Cholesterol"
  ) %>%
  mutate(
    Time = factor(Time, levels = c("Before", "After4weeks", "After8weeks")),
    Margarine = factor(Margarine, levels = c("B", "A")) 
  )

# Replacement for raincloud plot: boxplot + jitter
plot_box_jitter <- function(timepoint) {
  df_long %>%
    filter(Time == timepoint) %>%
    ggplot(aes(x = Margarine, y = Cholesterol, fill = Margarine)) +
    geom_boxplot(alpha = 0.6, width = 0.4, outlier.shape = NA) +
    geom_jitter(aes(color = Margarine), width = 0.12, size = 2, alpha = 0.6) +
    theme_minimal(base_size = 10) +
    labs(
      title = paste("Distribution Plot –", timepoint),
      x = "Margarine Brand",
      y = "Cholesterol"
    ) +
    scale_fill_manual(values = c("B" = "#377eb8", "A" = "#e41a1c")) +
    scale_color_manual(values = c("B" = "#377eb8", "A" = "#e41a1c")) +
    theme(legend.position = "none")
}

plot_before   <- plot_box_jitter("Before")
plot_after4   <- plot_box_jitter("After4weeks")
plot_after8   <- plot_box_jitter("After8weeks")

plot_before
plot_after4
plot_after8
```

**Remark.** A visual inspection was conducted using raincloud plots for each of the 6 interaction groups (Brand A and Brand B across three time points: Before, After 4 Weeks, and After 8 Weeks). These plots, which visualize the raw data points alongside the density distribution, reveal that the individual observations are clustered consistently around the central tendency of their respective groups. All data points fall within a reasonable distance from the interquartile range, with no extreme values appearing detached from the main "cloud" or distribution density. Consequently, there is no evidence of significant outliers that could skew the analysis, and Assumption 4 is satisfied.

#### Assumption 5: The dependent variable should be approximately normally distributed for each cell of the design.

```{r descriptives-multilevel, echo=FALSE, message=FALSE, warning=FALSE}
library(dplyr)
library(rstatix)
library(moments)
library(tidyr)
library(knitr)
library(kableExtra)

descriptives <- df_long %>%
  group_by(Time, Margarine) %>%
  summarise(
    Valid = dplyr::n(),
    Mean = mean(Cholesterol, na.rm = TRUE),
    `Std. Deviation` = sd(Cholesterol, na.rm = TRUE),
    Minimum = min(Cholesterol, na.rm = TRUE),
    Maximum = max(Cholesterol, na.rm = TRUE),
    Skewness = skewness(Cholesterol, na.rm = TRUE),
    `Std. Error of Skewness` = sqrt(6/Valid),
    Kurtosis = kurtosis(Cholesterol, na.rm = TRUE) - 3,
    `Std. Error of Kurtosis` = sqrt(24/Valid),
    Shapiro_Wilk = shapiro.test(Cholesterol)$statistic,
    `P-value Shapiro-Wilk` = shapiro.test(Cholesterol)$p.value,
    .groups = "drop"
  )

descriptives_long <- descriptives %>%
  pivot_longer(cols = Valid:`P-value Shapiro-Wilk`, names_to = " ", values_to = "Value") %>%
  unite("Time_Margarine", Time, Margarine, sep = "_") %>%
  pivot_wider(names_from = Time_Margarine, values_from = Value)

time_points <- c("Before", "After 4 Weeks", "After 8 Weeks")
margarine_sub <- c("A", "B")
header_matrix <- rep(margarine_sub, times = length(time_points))

descriptives_long %>%
  kable(
    caption = "Descriptive Statistics of Cholesterol by Time and Margarine",
    digits = 2,
    booktabs = TRUE,
    align = c("l", rep("c", length(header_matrix)))
  ) %>%
  add_header_above(c(" " = 1, "Before" = 2, "After 4 Weeks" = 2, "After 8 Weeks" = 2)) %>%
  kable_styling(
    latex_options = c("striped", "hold_position"),
    font_size = 10
  )
```

**Remark.** The assumption of normality was assessed using the Shapiro-Wilk test on the Cholesterol Level data for each of the 6 interaction cells (Brand A and Brand B at the Baseline, 4-Week, and 8-Week time points). The results indicated that the data for both margarine groups at all three time intervals were normally distributed, as the Shapiro-Wilk $p$-values were all greater than the significance level of 0.05.

Specifically, the results were as follows:
\begin{itemize}
    \item \textbf{Brand A:} Before ($p = 0.29$), After 4 Weeks ($p = 0.15$), and After 8 Weeks ($p = 0.17$).
    \item \textbf{Brand B:} Before ($p = 0.13$), After 4 Weeks ($p = 0.40$), and After 8 Weeks ($p = 0.22$).
\end{itemize}

Since all $p > 0.05$, we fail to reject the null hypothesis of normality. This conclusion is further corroborated by an inspection of the skewness and kurtosis values, which fell within the acceptable range (typically between -1.96 and +1.96), suggesting the distributions are symmetrical and not overly peaked or flat. Therefore, Assumption 5 is satisfied, and the data is suitable for parametric analysis.

#### Assumption 6: The variance of your dependent variable should be equal between the groups of the between-subjects factor, referred to as the assumption of homogeneity of variances.

```{r levene-test-jasp, echo=FALSE, message=FALSE, warning=FALSE}
library(dplyr)
library(car)
library(knitr)
library(kableExtra)

df$Margarine <- factor(df$Margarine, levels = c("A", "B"))

levene_results <- function(time_col) {
  formula <- as.formula(paste(time_col, "~ Margarine"))
  test <- car::leveneTest(formula, data = df, center = mean)  # mean-based for JASP match
  data.frame(
    Time = time_col,
    F = test$`F value`[1],
    df1 = test$Df[1],
    df2 = test$Df[2],
    p_value = test$`Pr(>F)`[1]
  )
}

time_points <- c("Before", "After4weeks", "After8weeks")

levene_table <- do.call(rbind, lapply(time_points, levene_results))

levene_table <- levene_table %>%
  mutate(across(c(F, df1, df2, p_value), ~round(., 3)))

levene_table %>%
  kable(
    caption = "Levene's Test for Homogeneity of Variances (Mean-based, matching JASP)",
    col.names = c("Time", "F", "df1", "df2", "p-value"),
    booktabs = TRUE,
    align = "c"
  ) %>%
  kable_styling(latex_options = c("striped", "hold_position"), font_size = 10)
```

**Remark.** The assumption of homogeneity of variances was assessed using Levene’s Test for Equality of Variances. This test examines whether the variance in cholesterol levels is consistent across the two Margarine groups (Brand A and Brand B) at each specific time point. The results revealed that the $p$-values for the Levene’s test were less than 0.05 for all three measurement intervals (Before, After 4 Weeks, and After 8 Weeks).Because the $p$-values fell below the significance threshold, we reject the null hypothesis that the variances are equal. This indicates that the spread or variability of cholesterol data is significantly different between Brand A and Brand B at every stage of the study. Consequently, the assumption of homogeneity of variances is violated, suggesting that interpreting the standard ANOVA results may require caution or robust corrections (such as ignoring the violation if sample sizes are equal, or using a stricter alpha level).

#### Assumption 7: There should be homogeneity of covariances.

```{r, echo=FALSE, message=FALSE, warning=FALSE}
library(dplyr)
library(biotools) 
library(tidyr)
library(knitr)
library(kableExtra)

df_wide <- df_long %>%
  pivot_wider(id_cols = c(ID, Margarine), names_from = Time, values_from = Cholesterol)

df_wide_complete <- df_wide %>% drop_na(Before, After4weeks, After8weeks)
df_wide_complete$Margarine <- factor(df_wide_complete$Margarine)


box_m_result <- boxM(df_wide_complete[, c("Before","After4weeks","After8weeks")],
                     grouping = df_wide_complete$Margarine)


box_m_result


box_m_table <- tibble(
  Test = "Box's M",
  M = round(box_m_result$statistic, 3),
  `df` = paste0(box_m_result$parameter[1]),
  `p-value` = round(box_m_result$p.value, 3)
)

box_m_table %>%
  kable(caption = "Box's M Test (complete cases)", booktabs = TRUE, align = "c") %>%
  kable_styling(latex_options = c("striped", "hold_position"))

```

**Remark.** Box’s M test indicates that the covariance matrices of the cholesterol measurements between Margarine A and B are not significantly different (M = 4.048, df1 = 6, p = 0.670). Therefore, the assumption of homogeneity of covariances is met.

#### Assumption 8: The variance of the differences between groups should be equal, referred to as the assumption of sphericity.

```{r sphericity-test, echo=FALSE, message=FALSE, warning=FALSE}

# install.packages("ez") 
library(ez)

df_long$ID <- df_long$ID  
df_long$Time <- factor(df_long$Time, levels = c("Before","After4weeks","After8weeks"))
df_long$Margarine <- factor(df_long$Margarine)

ez_res <- ezANOVA(
  data = df_long,
  dv = Cholesterol,
  wid = ID,
  within = Time,
  between = Margarine,
  type = 3,
  detailed = TRUE,
  return_aov = TRUE
)

ez_res$`Mauchly's Test for Sphericity`
ez_res$`Sphericity Corrections`

```

**Remark.** Mauchly’s test showed that the assumption of sphericity was violated (W = 0.462, Chi-squared = 11.58, df = 2, p = 0.003). Therefore, the Greenhouse-Geisser (epsilon = 0.65) and Huynh-Feldt (epsilon = 0.684) corrections should be used in the repeated-measures ANOVA to adjust for this violation.

## Two-way mixed ANOVA (Mixed: between = Margarine, within = Time)

```{r}
library(tidyverse)
library(afex)
library(knitr)
library(kableExtra)




df_long <- df %>%
  pivot_longer(
    cols = c(Before, After4weeks, After8weeks),
    names_to = "Time",
    values_to = "Cholesterol"
  )

head(df_long)


df_long$ID <- factor(df_long$ID)
df_long$Time <- factor(df_long$Time, levels = c("Before", "After4weeks", "After8weeks"))
df_long$Margarine <- factor(df_long$Margarine)


anova_result <- aov_ez(
  id = "ID",
  dv = "Cholesterol",
  between = "Margarine",
  within = "Time",
  data = df_long,
  type = 3
)

anova_summary <- afex::nice(anova_result, es = "pes")


anova_summary %>%
  knitr::kable(
    caption = "Two-way Mixed ANOVA Summary for Cholesterol Levels",
    digits = 3,
    booktabs = TRUE
  ) %>%
  kable_styling(
    full_width = FALSE,
    position = "center",
    bootstrap_options = c("striped", "hover", "condensed", "responsive")
  )


```
**Remarks.**
The mixed ANOVA revealed a significant main effect of Time, indicating that cholesterol levels changed across the three measurement points. This effect remained significant even after applying the Greenhouse–Geisser correction necessitated by the violation of sphericity. There was also a significant main effect of Margarine, suggesting that average cholesterol levels differed between Brand A and Brand B. Furthermore, the analysis showed a significant Time × Margarine interaction, meaning that the pattern of cholesterol change over time varied across the two brands. Because of this significant interaction, interpretation focuses on simple main effects and post hoc comparisons rather than the main effects in isolation.

## Post Hoc

```{r}


emm_time <- emmeans(anova_result, ~ Time)
pw_time <- pairs(emm_time, adjust = "bonferroni")
knitr::kable(as.data.frame(pw_time), digits = 3, caption = "Pairwise Comparisons for Time (Bonferroni)")

emm_time_by_marg <- emmeans(anova_result, pairwise ~ Time | Margarine, adjust = "bonferroni")
knitr::kable(as.data.frame(emm_time_by_marg$contrasts), digits = 3, caption = "Time Comparisons Within Each Margarine Brand")

emm_marg_by_time <- emmeans(anova_result, pairwise ~ Margarine | Time, adjust = "bonferroni")
contr_df <- as.data.frame(emm_marg_by_time$contrasts)
knitr::kable(
  contr_df,
  digits = 3,
  caption = "Margarine Comparisons at Each Time Point"
)

```
**Remarks.**
Post hoc comparisons for the main effect of Time showed that cholesterol levels differed significantly between all pairs of time points, indicating a steady decline from Before to After 4 Weeks and then again from After 4 Weeks to After 8 Weeks. When examining time comparisons within each margarine brand, both Brand A and Brand B exhibited significant reductions in cholesterol over time, although the size and pattern of reductions differed, which supports the presence of the significant interaction. Additionally, comparisons between the margarine brands at each time point showed no significant difference at baseline, but significant differences emerged at both Week 4 and Week 8, with one brand maintaining notably lower cholesterol levels at these later time points.

## Simple main effects

```{r}

library(tidyverse)
library(afex)
library(knitr)
library(kableExtra)


df_long <- df_wide %>%
pivot_longer(
cols = c("Before", "After4weeks", "After8weeks"), 
names_to = "Time",
values_to = "Cholesterol"
)


df_long <- df_long %>%
mutate(
ID = factor(ID),
Margarine = factor(Margarine),
Time = factor(Time)
)


get_sme_results_aov <- function(margarine_level) {
df_subset <- df_long %>% filter(Margarine == margarine_level)


aov_subset <- aov(Cholesterol ~ Time + Error(ID/Time), data = df_subset)



aov_summary <- summary(aov_subset)[[2]]
sme_df <- as.data.frame(aov_summary[[1]])


ss_time <- as.numeric(sme_df["Time", "Sum Sq"])
df_time <- as.numeric(sme_df["Time", "Df"])
ms_time <- as.numeric(sme_df["Time", "Mean Sq"])
f_time <- as.numeric(sme_df["Time", "F value"])
df_resid <- as.numeric(sme_df["Residuals", "Df"])



p_time <- pf(f_time, df_time, df_resid, lower.tail = FALSE)



data.frame(
"Level of Margarine" = margarine_level,
"Sum of Squares" = ss_time,
"df" = df_time,
"Mean Square" = ms_time,
"F" = f_time,
"p" = p_time,
check.names = FALSE
)
}


results_b <- get_sme_results_aov("B")
results_a <- get_sme_results_aov("A")



final_table <- bind_rows(results_b, results_a)


final_table %>%
mutate(
`Sum of Squares` = format(round(`Sum of Squares`, 3), nsmall = 3),
`Mean Square` = format(round(`Mean Square`, 3), nsmall = 3),
`F` = format(round(F, 2), nsmall = 2),
`p` = ifelse(p < 0.001, "<.001", format(round(p, 3), nsmall = 3))
) %>%
knitr::kable(
caption = "Simple Main Effects",
align = "c"
) %>%
kable_styling(
bootstrap_options = "striped",
full_width = FALSE
) %>%
add_header_above(c(" " = 6)) %>%
add_header_above(c("Simple Main Effects - Time" = 6)) %>%
footnote(
general = "Note. Type III Sum of Squares",
general_title = "",
threeparttable = TRUE
)

```
**Remarks.**
The simple main effects analysis showed that Time had a significant effect on cholesterol levels within each margarine brand. For Brand A, cholesterol decreased consistently across all three time points, demonstrating a strong and steady treatment effect. For Brand B, cholesterol levels also changed significantly over time, but the reductions were more modest compared to Brand A. These findings indicate that although both brands were effective in lowering cholesterol, Brand A produced a more pronounced improvement across the duration of the study.


## **Reporting**
A two-way mixed ANOVA was conducted to examine whether cholesterol levels changed over time and whether these changes differed depending on the brand of margarine consumed. Cholesterol was measured at three time points—before using the margarine, after four weeks, and after eight weeks—for participants assigned to either Brand A or Brand B. Prior to the main analysis, the assumptions of the test were evaluated. The data met the requirements for normality, the absence of outliers, and homogeneity of covariance matrices. Although the assumption of equal variances was violated and the test for sphericity was significant, these issues were addressed using appropriate statistical corrections such as the Greenhouse–Geisser adjustment.

The results revealed a significant main effect of Time, indicating that cholesterol levels changed notably across the three measurement points. A significant main effect of Margarine was also observed, suggesting that the two brands differed in their overall impact on cholesterol levels. Most importantly, a significant Time × Margarine interaction emerged, meaning that the pattern of cholesterol change over time varied depending on which brand was used.

Post hoc tests and simple main effects analyses were conducted to further explore this interaction. Across all participants, cholesterol levels decreased significantly from the initial measurement to Week 4, and again from Week 4 to Week 8. When each brand was examined separately, both Brand A and Brand B showed reductions in cholesterol over time; however, Brand A demonstrated a more consistent and greater decrease. This difference became more pronounced when comparing the brands at each time point: although cholesterol levels were initially similar, distinctions appeared by Week 4 and widened further by Week 8.

Overall, the findings indicate that while both margarine brands were effective in lowering cholesterol, Brand A produced a stronger and more sustained reduction. These results suggest that cholesterol levels tend to decline with continued margarine use, but the extent of improvement may depend on the specific brand consumed.
